---
import { getCollection } from 'astro:content';
import MainLayout from '../../layouts/MainLayout.astro';
import ImageCard from '@jaydixit/astro-utils/components/Image.astro';
import { smartQuotes } from '@jaydixit/astro-utils';
import { cldUrl } from '../../lib/cloudinary';

const posts = await getCollection('blog', ({ data }) => !data.draft);
const sortedPosts = posts
  .map((entry) => ({
    ...entry,
    data: {
      ...entry.data,
      publishDate: entry.data.publishDate ?? entry.data.updateDate ?? new Date(0),
    },
  }))
  .sort((a, b) => (b.data.publishDate?.valueOf() ?? 0) - (a.data.publishDate?.valueOf() ?? 0));
---

<MainLayout title="Blog">
  <section class="mx-auto max-w-4xl px-6 pb-24 pt-36 md:pt-48">
    <header class="mb-16 text-center">
      <p class="text-xs uppercase tracking-[0.3em] leading-[1.8] text-gray-500">Journal</p>
      <h1 class="mt-3 text-4xl font-semibold sm:text-5xl">Notes From The Field</h1>
      <p class="mt-4 text-base text-gray-600 sm:text-lg">
        Dispatches on photography, creative process, and the craft of storytelling.
      </p>
    </header>

    {sortedPosts.length === 0 && (
      <p class="text-center text-gray-500">No posts published yet. Check back soon.</p>
    )}

    <div class="grid gap-12">
      {sortedPosts.map(({ data, slug, body, id, render }) => {
        const publishDate = data.publishDate ? new Date(data.publishDate) : undefined;
        const formattedDate = publishDate
          ? publishDate.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            })
          : null;

        const heroImage = data.imagePublicId ? cldUrl(data.imagePublicId, 1200) : data.image ?? null;
        const excerpt = data.excerpt ? smartQuotes(data.excerpt) : null;

        return (
          <article class="group overflow-hidden rounded-3xl border border-black/5 bg-white/90 shadow-[0_25px_70px_-30px_rgba(15,23,42,0.35)] transition hover:-translate-y-1 hover:bg-white">
            <a href={`/blog/${slug}/`} class="block no-underline">
              {heroImage && (
                <figure class="relative aspect-[3/2] overflow-hidden bg-slate-100">
                  <ImageCard
                    src={heroImage}
                    alt={data.imageAlt ?? data.title}
                    width={1200}
                    height={800}
                    class="h-full w-full object-cover transition duration-500 group-hover:scale-[1.02]"
                  />
                </figure>
              )}

              <div class="p-8">
                <header class="flex flex-col gap-3 sm:flex-row sm:items-baseline sm:justify-between">
                  <h2 class="text-2xl font-semibold tracking-tight text-gray-900 transition group-hover:text-gray-700">
                    {data.title}
                  </h2>
                  {formattedDate && (
                  <time datetime={publishDate?.toISOString()} class="text-sm uppercase tracking-[0.2em] text-gray-400">
                    {formattedDate}
                  </time>
                )}
              </header>

              {excerpt && (
                <p class="mt-4 text-[15px] leading-relaxed text-gray-600">
                  {excerpt}
                </p>
              )}

              {data.tags && data.tags.length > 0 && (
                <ul class="mt-6 flex flex-wrap gap-2">
                  {data.tags.map((tag) => (
                    <li class="rounded-full bg-slate-900 px-3 py-1 text-xs uppercase tracking-[0.2em] text-white/90">
                      {tag}
                    </li>
                  ))}
                </ul>
              )}

              <span class="mt-6 inline-flex items-center text-sm font-medium text-slate-800 group-hover:text-slate-600">
                Read story
                <svg class="ml-2 h-3 w-3" viewBox="0 0 12 12" aria-hidden="true">
                  <path
                    fill="currentColor"
                    d="M3.172 11.828 2 10.657l5.485-5.485H1V3h8.172l.707.707-6.707 6.707z"
                  />
                </svg>
              </span>
              </div>
            </a>
          </article>
        );
      })}
    </div>
  </section>
</MainLayout>
