---
import MainLayout from '../layouts/MainLayout.astro';
// Import image configuration
import { images } from '../data/homepage-images.js';

// Algorithm to optimize image order for minimal gaps
function optimizeImageOrder(images) {
  // Separate images by size
  const sizeGroups = {
    wide_tall: [], // 2x2 - largest, place first for anchor points
    wide: [],      // 2x1 - landscape 
    tall: [],      // 1x2 - tall portrait
    regular: []    // 1x1 - standard, use to fill gaps
  };
  
  images.forEach(img => {
    sizeGroups[img.size].push(img);
  });
  
  const optimized = [];
  
  // Strategy: Place large items first, then fill gaps with smaller items
  // 1. Start with a wide_tall to anchor the layout
  if (sizeGroups.wide_tall.length > 0) {
    optimized.push(sizeGroups.wide_tall.shift());
  }
  
  // 2. Add some regular items to fill around it (need 3-4 for a 5-column grid)
  const regularToAdd = Math.min(3, sizeGroups.regular.length);
  for (let i = 0; i < regularToAdd; i++) {
    if (sizeGroups.regular.length > 0) {
      optimized.push(sizeGroups.regular.shift());
    }
  }
  
  // 3. Add wide items (they fit well after regulars)
  while (sizeGroups.wide.length > 0 && optimized.length < 7) {
    optimized.push(sizeGroups.wide.shift());
    // After each wide, add a regular to fill the gap
    if (sizeGroups.regular.length > 0) {
      optimized.push(sizeGroups.regular.shift());
    }
  }
  
  // 4. Place remaining wide_tall items with regular items between
  while (sizeGroups.wide_tall.length > 0) {
    // Add 1-2 regular items before the next wide_tall to prevent gaps
    const fillCount = Math.min(2, sizeGroups.regular.length);
    for (let i = 0; i < fillCount; i++) {
      if (sizeGroups.regular.length > 0) {
        optimized.push(sizeGroups.regular.shift());
      }
    }
    optimized.push(sizeGroups.wide_tall.shift());
  }
  
  // 5. Add remaining items
  [...sizeGroups.wide, ...sizeGroups.tall, ...sizeGroups.regular].forEach(img => {
    optimized.push(img);
  });
  
  return optimized;
}

// Optimize the image order
const optimizedImages = optimizeImageOrder(images);

// Build the photo array from optimized configuration
const highlightPhotos = optimizedImages.map(img => ({
  src: `/highlights/${img.filename}`,
  filename: img.filename,
  caption: img.caption,
  size: img.size
}));
---

<MainLayout>
  <div class="portfolio-wrap">
    <div class="portfolio-items masonry-items" data-masonry-type="photography">
      {highlightPhotos.map((photo, index) => (
        <div class={`col elastic-portfolio-item ${photo.size}`} data-delay-amount={index}>
          <div class="inner-wrap">
            <div class="work-item">
              <a href={photo.src} data-gallery="main-gallery">
                <img 
                  src={photo.src} 
                  alt={photo.caption}
                  loading="lazy"
                />
              </a>
              <div class="work-info-bg"></div>
              <div class="work-info">
                <h3>{photo.caption}</h3>
              </div>
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>
</MainLayout>

<style>
/* Portfolio container - full width, no margins */
.portfolio-wrap {
  position: relative;
  margin: 0;
  padding: 0;
  width: 100%;
}

/* Masonry Container */
.portfolio-items {
  position: relative;
  width: 100%;
  margin: 0 auto;
  padding: 0;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.portfolio-items.isotope-initialized {
  opacity: 1;
}

/* Base column width - Responsive percentage based */
.portfolio-items .col {
  width: 20%; /* 5 columns to fill width */
  padding: 2px;
  box-sizing: border-box;
  float: left;
}

/* Size variations */
.portfolio-items .col.regular {
  width: 20%; /* 1 unit - 5 columns */
}

.portfolio-items .col.wide {
  width: 40%; /* 2 units wide */
}

.portfolio-items .col.tall {
  width: 20%; /* 1 unit width but taller */
}

.portfolio-items .col.wide_tall {
  width: 40%; /* 2 units wide */
}

/* Responsive breakpoints */
@media only screen and (max-width: 1600px) {
  .portfolio-items .col.regular,
  .portfolio-items .col.tall {
    width: 25%; /* 4 columns */
  }
  .portfolio-items .col.wide,
  .portfolio-items .col.wide_tall {
    width: 50%; /* 2x width */
  }
}

@media only screen and (max-width: 1200px) {
  .portfolio-items .col.regular,
  .portfolio-items .col.tall {
    width: 33.333%; /* 3 columns */
  }
  .portfolio-items .col.wide,
  .portfolio-items .col.wide_tall {
    width: 66.666%; /* 2x width */
  }
}

@media only screen and (max-width: 768px) {
  .portfolio-items .col.regular,
  .portfolio-items .col.tall {
    width: 50%; /* 2 columns */
  }
  .portfolio-items .col.wide,
  .portfolio-items .col.wide_tall {
    width: 100%; /* Full width */
  }
}

@media only screen and (max-width: 480px) {
  .portfolio-items .col,
  .portfolio-items .col.regular,
  .portfolio-items .col.wide,
  .portfolio-items .col.tall,
  .portfolio-items .col.wide_tall {
    width: 100%; /* 1 column on mobile */
  }
}

/* Inner wrapper */
.portfolio-items .col .inner-wrap {
  position: relative;
  overflow: hidden;
  background: #f5f5f5;
}

/* Work item container */
.portfolio-items .col .work-item {
  position: relative;
  overflow: hidden;
  cursor: pointer;
}

/* Images - fixed aspect ratio with cropping */
.portfolio-items .col img {
  width: 100%;
  height: 100%;
  display: block;
  object-fit: cover;
  transition: transform 0.45s cubic-bezier(0.3, 0.1, 0.3, 1);
}

/* Set fixed aspect ratios for each size */
.portfolio-items .col.regular .work-item {
  aspect-ratio: 3 / 4; /* Portrait ratio like 320x430 */
}

.portfolio-items .col.wide .work-item {
  aspect-ratio: 3 / 2; /* Landscape ratio */
}

.portfolio-items .col.tall .work-item {
  aspect-ratio: 3 / 5; /* Taller portrait */
}

.portfolio-items .col.wide_tall .work-item {
  aspect-ratio: 3 / 4; /* Same as regular but bigger */
}

/* Hover effects */
.portfolio-items .col:hover img {
  transform: scale(1.07);
}

/* Work info overlay */
.portfolio-items .work-info-bg {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0);
  transition: background 0.45s ease;
  pointer-events: none;
}

.portfolio-items .col:hover .work-info-bg {
  background: rgba(0, 0, 0, 0.4);
}

.portfolio-items .work-info {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 20px;
  color: #fff;
  transform: translateY(100%);
  transition: transform 0.45s cubic-bezier(0.3, 0.1, 0.3, 1);
}

.portfolio-items .col:hover .work-info {
  transform: translateY(0);
}

.portfolio-items .work-info h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 400;
}

/* Animation */
@keyframes portfolioFadeIn {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.portfolio-items .col .inner-wrap {
  animation: portfolioFadeIn 0.6s ease forwards;
  opacity: 0;
}

.portfolio-items.animated-in .col .inner-wrap {
  opacity: 1;
}

/* Staggered animation */
.portfolio-items .col:nth-child(1) .inner-wrap { animation-delay: 0ms; }
.portfolio-items .col:nth-child(2) .inner-wrap { animation-delay: 85ms; }
.portfolio-items .col:nth-child(3) .inner-wrap { animation-delay: 170ms; }
.portfolio-items .col:nth-child(4) .inner-wrap { animation-delay: 255ms; }
.portfolio-items .col:nth-child(5) .inner-wrap { animation-delay: 340ms; }
.portfolio-items .col:nth-child(6) .inner-wrap { animation-delay: 425ms; }
.portfolio-items .col:nth-child(7) .inner-wrap { animation-delay: 510ms; }
.portfolio-items .col:nth-child(8) .inner-wrap { animation-delay: 595ms; }
</style>

<!-- Load Isotope and required libraries -->
<script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
<script src="https://unpkg.com/isotope-layout@3/dist/isotope.pkgd.min.js"></script>

<script>
  import GLightbox from 'glightbox';
  
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('.portfolio-items');
    
    // Initialize GLightbox
    const lightbox = GLightbox({
      selector: '[data-gallery="main-gallery"]',
      touchNavigation: true,
      loop: true,
      autoplayVideos: false,
      zoomable: true,
      draggable: true,
    });
    
    // Wait for images to load, then initialize Isotope
    imagesLoaded(container, function() {
      // Initialize Isotope with optimized masonry layout
      const iso = new Isotope(container, {
        itemSelector: '.col',
        layoutMode: 'masonry',
        masonry: {
          columnWidth: '.col.regular',
          gutter: 0,
          fitWidth: false,
          horizontalOrder: false // Vertical order fills columns top to bottom
        },
        percentPosition: false,
        transitionDuration: '0.3s',
        sortBy: 'original-order',
        hiddenStyle: {
          opacity: 0,
          transform: 'translateY(30px)'
        },
        visibleStyle: {
          opacity: 1,
          transform: 'translateY(0)'
        }
      });
      
      // Optional: Force relayout after a delay to ensure proper positioning
      setTimeout(() => {
        iso.layout();
      }, 100);
      
      // Add initialized class
      container.classList.add('isotope-initialized');
      
      // Trigger animation
      setTimeout(() => {
        container.classList.add('animated-in');
      }, 100);
      
      // Handle window resize
      let resizeTimer;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
          iso.layout();
        }, 250);
      });
    });
  });
</script>
