---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro:assets';
import MainLayout from '../../layouts/MainLayout.astro';

type GalleryEntry = {
  name: string;
  displayName: string;
  imageCount: number;
  sampleImage?: ImageMetadata;
  url: string;
  category: string;
};

const imageModules = import.meta.glob<{ default: ImageMetadata }>(
  '../../gallery/photos/**/*.{jpg,jpeg,png,webp,gif}',
  { eager: true }
);

function toTitleCase(slug: string) {
  return slug
    .split('-')
    .map(part => part.charAt(0).toUpperCase() + part.slice(1))
    .join(' ');
}

const grouped = new Map<string, ImageMetadata[]>();

Object.entries(imageModules).forEach(([key, module]) => {
  const relativePath = key.replace('../../gallery/photos/', '');
  const segments = relativePath.split('/');
  segments.pop();
  const folder = segments.join('/');
  if (!folder) return;

  if (!grouped.has(folder)) {
    grouped.set(folder, []);
  }

  grouped.get(folder)?.push(module.default);
});

const galleries = Array.from(grouped.entries()).map(([folder, images]) => {
  if (images.length === 0) return null;

  const displayName = folder
    .split('/')
    .map(toTitleCase)
    .join(' â†’ ');

  const entry: GalleryEntry = {
    name: folder,
    displayName,
    imageCount: images.length,
    sampleImage: images[0],
    url: `/gallery/${folder}`,
    category: folder.split('/')[0] ?? 'other'
  };

  return entry;
}).filter((entry): entry is GalleryEntry => entry !== null);

const categorizedGalleries = galleries.reduce<Record<string, GalleryEntry[]>>((acc, gallery) => {
  const category = gallery.category;
  if (!acc[category]) acc[category] = [];
  acc[category].push(gallery);
  return acc;
}, {});
---

<MainLayout>
  <section class="py-16 pt-24">
    <div class="container mx-auto px-4 max-w-7xl">
      <div class="mb-16 text-center">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">Photo Galleries</h1>
        <p class="text-gray-600 max-w-xl mx-auto">
          Browse my photography collections organized by theme and event
        </p>
      </div>

      {Object.keys(categorizedGalleries).length > 0 ? (
        Object.entries(categorizedGalleries).map(([category, categoryGalleries]) => (
          <div class="mb-12">
            <h2 class="text-2xl font-bold mb-6 capitalize text-gray-800">
              {category.split('-').join(' ')}
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
              {categoryGalleries.map(gallery => (
                <a 
                  href={gallery.url}
                  class="group block bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2"
                >
                  <div class="aspect-[4/3] bg-gray-200 overflow-hidden">
                    {gallery.sampleImage ? (
                      <Image
                        src={gallery.sampleImage}
                        alt={gallery.displayName}
                        width={640}
                        height={480}
                        fit="cover"
                        class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                        loading="lazy"
                      />
                    ) : (
                      <div class="w-full h-full bg-gray-200" />
                    )}
                  </div>
                  
                  <div class="p-4">
                    <h3 class="text-lg font-semibold mb-2 group-hover:text-blue-600 transition-colors line-clamp-2">
                      {gallery.displayName}
                    </h3>
                    <p class="text-gray-600 text-sm">
                      {gallery.imageCount} {gallery.imageCount === 1 ? 'photo' : 'photos'}
                    </p>
                  </div>
                </a>
              ))}
            </div>
          </div>
        ))
      ) : (
        <div class="text-center py-16">
          <div class="text-gray-400 mb-4">
            <svg class="w-24 h-24 mx-auto" fill="currentColor" viewBox="0 0 24 24">
              <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
            </svg>
          </div>
          <h3 class="text-xl font-semibold mb-2">No galleries found</h3>
          <p class="text-gray-600">
            Create gallery folders in <code class="bg-gray-100 px-2 py-1 rounded text-sm">src/gallery/photos/</code> to get started.
          </p>
        </div>
      )}
    </div>
  </section>
</MainLayout>
