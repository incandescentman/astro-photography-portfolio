---
import fs from 'fs';
import path from 'path';
import MainLayout from '../../layouts/MainLayout.astro';

// Get all gallery folders from public/photos
const photosDir = path.join(process.cwd(), 'public/photos');
const galleries = [];

function getAllGalleries(dir, basePath = '') {
  if (!fs.existsSync(dir)) return;
  
  const items = fs.readdirSync(dir);
  
  for (const item of items) {
    const itemPath = path.join(dir, item);
    const relativePath = basePath ? `${basePath}/${item}` : item;
    
    if (fs.statSync(itemPath).isDirectory()) {
      // Check if this folder has images
      const imageFiles = fs.readdirSync(itemPath).filter(f => 
        /\.(jpg|jpeg|png|webp|gif)$/i.test(f)
      );
      
      if (imageFiles.length > 0) {
        const sampleImage = imageFiles[0];
        const displayName = relativePath.split('/').map(part => 
          part.split('-').map(word => 
            word.charAt(0).toUpperCase() + word.slice(1)
          ).join(' ')
        ).join(' â†’ ');
        
        galleries.push({
          name: relativePath,
          displayName,
          imageCount: imageFiles.length,
          sampleImage: `/photos/${relativePath}/${sampleImage}`,
          url: `/gallery/${relativePath}`,
          category: relativePath.split('/')[0] // top-level category
        });
      }
      
      // Recursively check subfolders
      getAllGalleries(itemPath, relativePath);
    }
  }
}

getAllGalleries(photosDir);

// Group galleries by category
const categorizedGalleries = galleries.reduce((acc, gallery) => {
  const category = gallery.category;
  if (!acc[category]) acc[category] = [];
  acc[category].push(gallery);
  return acc;
}, {});
---

<MainLayout>
  <section class="py-16 pt-24">
    <div class="container mx-auto px-4 max-w-7xl">
      <div class="mb-16 text-center">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">Photo Galleries</h1>
        <p class="text-gray-600 max-w-xl mx-auto">
          Browse my photography collections organized by theme and event
        </p>
      </div>

      {Object.keys(categorizedGalleries).length > 0 ? (
        Object.entries(categorizedGalleries).map(([category, categoryGalleries]) => (
          <div class="mb-12">
            <h2 class="text-2xl font-bold mb-6 capitalize text-gray-800">
              {category.split('-').join(' ')}
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
              {categoryGalleries.map(gallery => (
                <a 
                  href={gallery.url}
                  class="group block bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2"
                >
                  <div class="aspect-[4/3] bg-gray-200 overflow-hidden">
                    <img 
                      src={gallery.sampleImage} 
                      alt={gallery.displayName}
                      class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                      loading="lazy"
                    />
                  </div>
                  
                  <div class="p-4">
                    <h3 class="text-lg font-semibold mb-2 group-hover:text-blue-600 transition-colors line-clamp-2">
                      {gallery.displayName}
                    </h3>
                    <p class="text-gray-600 text-sm">
                      {gallery.imageCount} {gallery.imageCount === 1 ? 'photo' : 'photos'}
                    </p>
                  </div>
                </a>
              ))}
            </div>
          </div>
        ))
      ) : (
        <div class="text-center py-16">
          <div class="text-gray-400 mb-4">
            <svg class="w-24 h-24 mx-auto" fill="currentColor" viewBox="0 0 24 24">
              <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
            </svg>
          </div>
          <h3 class="text-xl font-semibold mb-2">No galleries found</h3>
          <p class="text-gray-600">
            Create gallery folders in <code class="bg-gray-100 px-2 py-1 rounded text-sm">public/photos/</code> to get started.
          </p>
        </div>
      )}
    </div>
  </section>
</MainLayout>